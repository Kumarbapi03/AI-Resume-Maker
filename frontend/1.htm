<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Resume Builder | Offline Mode</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lobster&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Use window.jspdf = window.jspdf.jsPDF for ES Module compatibility
        window.jsPDF = window.jspdf.jsPDF;
    </script>
    
    <style>
        /* --- General & Body Setup --- */
        :root {
            /* Professional Blue Theme */
            --primary-lightest: #E8F4F8; /* Light Blue */
            --primary-light: #A5D8FF;    /* Medium Blue */
            --primary-medium: #4A90E2;   /* Corporate Blue */
            --primary-dark: #2C3E50;     /* Dark Blue (Main Accent) */
            --secondary-dark: #1A2530;   /* Very Dark Blue */
            --secondary-darkest: #0F1419; /* Deepest Blue (Text) */
            --border-light: #D1E7F5;     /* Lighter blue for borders */
            --accent-color: #3498DB;     /* Accent Blue */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-lightest);
            color: var(--secondary-darkest);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* --- START: CSS FOR TOP BAR --- */
        .top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2.5rem; 
            position: relative;
            z-index: 100;
            flex-shrink: 0;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logo {
            font-family: 'Lobster', cursive;
            font-size: 1.9rem;
            font-weight: 400;
            color: var(--primary-dark);
        }
        
        .language-switcher {
            position: relative;
        }

        .language-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            background-color: #fcfcfc;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mode-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--primary-medium);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 600;
            background-color: var(--primary-medium);
            color: white;
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        
        .mode-btn:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .language-btn:hover,
        .language-btn:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        .language-dropdown {
            display: none; 
            position: absolute;
            top: 110%;
            right: 0;
            min-width: 220px;
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid #eee;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 110;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-option {
            display: block;
            padding: 10px 16px;
            font-size: 0.95rem;
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        .language-option:hover {
            background-color: #f5f5f9;
        }
        
        .language-option.selected {
            font-weight: 600;
            color: var(--primary-dark);
            background-color: #eaf1f6;
        }
        /* --- END: CSS FOR TOP BAR --- */

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem 2rem;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 85px);
        }

        /* --- 1. Header Section --- */
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 2rem; 
            transition: all 0.3s ease; 
            padding-top: 2rem;
        }
        
        .header-content.hidden {
            display: none;
        }

        .ai-tag {
            background-color: #ffffff;
            color: var(--primary-medium);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 1rem;
            border: 1px solid var(--border-light);
        }

        .header-content h1 {
            font-size: 3rem;
            font-weight: 700;
            color: var(--secondary-darkest);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--primary-dark);
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .create-goal-btn {
            background-color: var(--primary-dark);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 14px rgba(44, 62, 80, 0.25);
            transition: all 0.3s ease;
        }
        
        .create-goal-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .create-goal-btn:hover {
            background-color: var(--primary-medium);
            box-shadow: 0 6px 16px rgba(44, 62, 80, 0.3);
            transform: translateY(-2px);
        }
        
        .create-goal-btn:disabled:hover {
            background-color: #aaa;
            box-shadow: 0 4px 14px rgba(44, 62, 80, 0.25);
            transform: none;
        }

        /* --- 2. Chat Display Area --- */
        .chat-display-area {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 10px;
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            background: #ffffff; 
            border: 1px solid var(--border-light); 
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .chat-display-area.visible {
            display: flex;
        }

        .chat-message {
            padding: 10px 16px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
            font-size: 0.95rem;
            animation: fadeIn 0.3s ease-out; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            background-color: #eaf1f6;
            color: var(--secondary-darkest); 
            align-self: flex-start;
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .bot-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            background: var(--primary-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem; 
        }
        
        .bot-icon svg {
             width: 16px;
             height: 16px;
             fill: white;
        }

        .bot-message-text {
            flex-grow: 1;
        }

        .user-message {
            background-color: var(--primary-dark); 
            color: white;
            align-self: flex-end;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            background: var(--primary-lightest);
            border: 1px solid var(--primary-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-size: 0.8rem;
            order: 2;
        }
        
        .user-icon svg {
             width: 16px;
             height: 16px;
             stroke: var(--primary-dark);
             fill: none;
        }

        .user-message-text {
            flex-grow: 1;
            order: 1;
        }

        /* --- Styles for typing indicator --- */
        .typing-indicator {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: #aaa;
            border-radius: 50%;
            animation: pulse 1.2s infinite ease-in-out;
        }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* --- START: CSS FOR OPTIONS --- */
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-self: flex-start;
            width: 100%;
            padding: 10px 0 5px 40px;
            animation: fadeIn 0.3s ease-out;
        }
        
        .option-btn {
            background-color: #ffffff;
            border: 1px solid var(--border-light);
            color: var(--primary-dark);
            padding: 8px 14px;
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn:hover {
            background-color: #eaf1f6;
            border-color: var(--primary-medium);
        }
        
        .option-btn.selected {
            background-color: var(--primary-dark);
            color: white;
            border-color: var(--primary-dark);
        }
        
        .option-btn.done-btn {
            background-color: var(--secondary-darkest);
            color: white;
            font-weight: 600;
        }
        /* --- END: CSS FOR OPTIONS --- */

        /* --- 3. AI Input Section --- */
        .ai-input-container {
            width: 100%;
            border-radius: 28px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light); 
            overflow: hidden;
            background: #ffffff; 
            flex-shrink: 0;
            margin-top: 1rem;
        }

        .ai-input-box {
            background-color: transparent; 
            padding: 0.5rem 0.75rem; 
            display: flex;
            flex-direction: row; 
            gap: 0.5rem; 
            align-items: center; 
        }

        input#goal-input {
            border: none;
            outline: none;
            background: transparent;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            color: #333; 
            width: 100%;
            line-height: 1.6;
            padding: 0.5rem; 
            flex-grow: 1; 
            transition: opacity 0.2s ease;
        }

        input#goal-input:disabled {
            background-color: #f9f9f9;
            opacity: 0.7;
            cursor: not-allowed;
        }

        input#goal-input::placeholder {
            color: #aaa; 
            font-weight: 500;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .icon-btn:hover {
            background-color: #f0f0f0; 
        }
        
        .icon-btn svg {
            stroke: #666; 
        }
        
        /* CSS FOR LISTENING STATE */
        .icon-btn#mic-btn.listening svg {
            stroke: #D93025;
            animation: pulse-mic 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse-mic {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .send-btn {
            background-color: var(--secondary-darkest); 
            color: white;
            border: none;
            width: 38px; 
            height: 38px; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; 
        }
        
        .send-btn:hover {
            background-color: var(--primary-dark); 
        }
        
        .send-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        
        .send-btn svg {
            stroke: white;
        }

        /* --- Custom Alert Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal-box {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        .modal-box p {
            font-size: 1rem;
            color: #333;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .modal-close-btn {
            background-color: var(--primary-dark); 
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-close-btn:hover {
            background-color: var(--primary-medium); 
        }

        /* --- ADDED: ENHANCED RESUME PREVIEW STYLES (Professional Layout) --- */
        #resume-preview-container {
            display: none; /* Hide by default */
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
            background: #ffffff;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            font-family: 'Inter', sans-serif;
            overflow-y: auto;
        }
        #resume-preview-container.visible {
            display: flex;
        }

        /* Professional resume layout */
        .resume-content {
            max-width: 750px; /* A4 width proxy */
            margin: 0 auto;
            color: #111;
            line-height: 1.4;
        }
        
        /* Header Section */
        .resume-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-dark);
            margin-bottom: 25px;
        }
        
        .resume-name {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--secondary-darkest);
            letter-spacing: 1px;
        }
        
        .resume-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 12px;
        }
        
        .resume-contact {
            font-size: 0.95rem;
            color: var(--primary-medium);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .resume-contact span {
            display: inline-block;
        }
        
        /* Section Styles */
        .resume-section {
            margin-bottom: 22px;
            padding-top: 10px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Professional Summary */
        .summary-text {
            font-size: 0.95rem;
            line-height: 1.5;
            text-align: justify;
        }
        
        /* Experience Section */
        .experience-item {
            margin-bottom: 18px;
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .job-title {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--secondary-darkest);
        }
        
        .job-date {
            font-weight: 500;
            color: var(--primary-medium);
        }
        
        .company-name {
            font-weight: 500;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }
        
        .job-description {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .achievement-list {
            list-style-type: disc;
            margin-top: 8px;
            padding-left: 20px;
        }
        
        .achievement-list li {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        /* Enhanced Skills Section */
        .skills-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .skill-category {
            margin-bottom: 15px;
        }
        
        .skill-category-title {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .skill-tag {
            background-color: var(--primary-lightest);
            color: var(--primary-dark);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
            margin: 2px 0;
            line-height: 1.4;
        }
        
        /* Education Section */
        .education-item {
            margin-bottom: 15px;
        }
        
        .education-degree {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--secondary-darkest);
        }
        
        .education-school {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .education-details {
            font-size: 0.9rem;
            color: var(--primary-medium);
        }
        
        /* Download Controls */
        .download-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
        }
        
        .download-btn {
            background-color: var(--primary-dark);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            background-color: var(--primary-medium);
            transform: translateY(-2px);
        }
        
        .back-btn {
            background-color: var(--primary-light);
            color: var(--secondary-darkest);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background-color: var(--border-light);
        }

        /* Print-specific styles to ensure clean PDF output */
        @media print {
            body, .resume-content {
                background: white !important;
                color: black !important;
            }
            .resume-header {
                border-bottom: 2px solid black !important;
            }
            .section-title {
                border-bottom: 1px solid black !important;
                color: black !important;
            }
            .top-bar, .ai-input-container, .options-container, .modal-overlay, #chat-display, .download-controls {
                display: none !important;
            }
            #resume-preview-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: auto;
                padding: 0;
                box-shadow: none;
                overflow: visible;
            }
            .container {
                padding: 0;
                height: auto;
            }
        }
    </style>
</head>
<body>

    <nav class="top-bar">
        <div class="logo">Resume Builder Pro</div>
        
        <div style="display: flex; align-items: center;">
            <button class="mode-btn" id="online-mode-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                <span>Online Builder</span>
            </button>
            
            <div class="language-switcher">
                <button class="language-btn" id="language-toggle-btn" aria-haspopup="true" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <span id="current-lang-text">English</span>
                </button>
                
                <div class="language-dropdown" id="language-dropdown-menu" role="menu">
                    <a href="#" class="language-option selected" role="menuitem" data-lang="en">English</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="hi">हिन्दी (Hindi)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="bn">বাংলা (Bengali)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="te">తెలుగు (Telugu)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="mr">मराठी (Marathi)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="ta">தமிழ் (Tamil)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="ur">اردو (Urdu)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="gu">ગુજરાતી (Gujarati)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="kn">ಕನ್ನಡ (Kannada)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="ml">മലയാളം (Malayalam)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="pa">ਪੰਜਾਬੀ (Punjabi)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="or">ଓଡ଼ିଆ (Odia)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="as">অসমীয়া (Assamese)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="mai">मैथिली (Maithili)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="sat">संताली (Santali)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="ks">कश्मीरी (Kashmiri)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="ne">नेपाली (Nepali)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="sd">सिन्धी (Sindhi)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="kok">कोंकणी (Konkani)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="doi">डोगरी (Dogri)</a>
                    <a href="#" class="language-option" role="menuitem" data-lang="mni">মৈতৈলোন্ (Manipuri)</a>
                </div>
            </div>
        </div>
    </nav>
    <main class="container">
        <header class="header-content" id="header-content">
            <span class="ai-tag">Professional Resume Builder</span>
            <h1>Create Your Perfect Resume</h1>
            <p class="subtitle">
                Build a professional, ATS-friendly resume in minutes. Our AI-powered assistant will guide you through the process step by step.
            </p>

            <button class="create-goal-btn" id="create-goal-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span id="create-goal-btn-text">Start Building Resume</span>
            </button>

        </header>

        <section class="chat-display-area" id="chat-display"></section>
        
        <section id="resume-preview-container">
            <div id="resume-content" class="resume-content">
                <!-- Resume content will be generated here -->
            </div>
            <div class="download-controls">
                <button class="back-btn" id="back-to-chat-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    <span>Back to Chat</span>
                </button>
                <button class="download-btn" id="download-pdf-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="13" x2="12" y2="19"></line>
                        <polyline points="15 16 12 19 9 16"></polyline>
                    </svg>
                    <span>Download Resume as PDF</span>
                </button>
            </div>
        </section>

        <section class="ai-input-container">
            <div class="ai-input-box">
                <button class="icon-btn" id="tts-btn" 
                    aria-label="Read text aloud">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>

                <input type="text" id="goal-input" 
                    placeholder="Please wait..." 
                    disabled>

                <button class="icon-btn" id="mic-btn" 
                    aria-label="Use microphone">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="22"></line>
                    </svg>
                </button>
                
                <button class="send-btn" 
                    aria-label="Generate"
                    disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="19" x2="12" y2="5"></line>
                        <polyline points="5 12 12 5 19 12"></polyline>
                    </svg>
                </button>
            </div>
        </section>

    </main>

    <div class="modal-overlay" id="custom-alert-overlay">
        <div class="modal-box">
            <p id="custom-alert-message">This is an alert message.</p>
            <button class="modal-close-btn" id="custom-alert-close">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- State Variables ---
            let currentLang = 'en';
            let translations = {}; 
            let chatState = 'awaiting_profession'; 
            let currentQuestionSet = [];
            let currentQuestionIndex = 0;
            let resumeData = {}; 
            
            // --- TTS State ---
            const synth = window.speechSynthesis;
            let lastSpokenText = "";
            let isSpeaking = false;

            const langMap = {
                'en': 'en-US', 'hi': 'hi-IN', 'bn': 'bn-IN', 'te': 'te-IN', 'mr': 'mr-IN',
                'ta': 'ta-IN', 'ur': 'ur-IN', 'gu': 'gu-IN', 'kn': 'kn-IN', 'ml': 'ml-IN',
                'pa': 'pa-IN', 'or': 'or-IN', 'as': 'as-IN', 'mai': 'hi-IN', 
                'sat': 'hi-IN', 'ks': 'ur-IN', 'ne': 'ne-NP', 'sd': 'ur-IN',
                'kok': 'mr-IN', 'doi': 'hi-IN', 'mni': 'bn-IN'
            };
            
            // --- Speech Recognition State ---
            let recognition;
            let isRecognizing = false;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const micBtn = document.querySelector('#mic-btn'); 
            
            if (!SpeechRecognition) {
                console.warn("Speech Recognition API not supported in this browser.");
                if(micBtn) micBtn.style.display = 'none'; 
            }
            
            const professions = [
                { key: 'cook' }, { key: 'electrical' }, { key: 'plumbing' },
                { key: 'driver' }, { key: 'carpentry' }, { key: 'welding' },
                { key: 'masonry' }, { key: 'painting' }, { key: 'mechanic' },
                { key: 'factory' }, { key: 'farm' }, { key: 'security' },
                { key: 'cleaning' }, { key: 'tailor' }, { key: 'construction' },
                { key: 'automotive' }, { key: 'general' } 
            ];

            // --- DOM Elements ---
            const alertOverlay = document.getElementById('custom-alert-overlay');
            const alertMessage = document.getElementById('custom-alert-message');
            const alertCloseBtn = document.getElementById('custom-alert-close');
            const chatDisplay = document.getElementById('chat-display');
            const headerContent = document.getElementById('header-content');
            const createGoalBtn = document.getElementById('create-goal-btn');
            const sendBtn = document.querySelector('.send-btn');
            const ttsBtn = document.querySelector('#tts-btn');
            const goalInput = document.getElementById('goal-input');
            const langButton = document.getElementById('language-toggle-btn');
            const langDropdown = document.getElementById('language-dropdown-menu');
            const langButtonText = document.getElementById('current-lang-text');
            const langOptions = document.querySelectorAll('.language-option');
            const onlineModeBtn = document.getElementById('online-mode-btn'); 

            // Resume Preview DOM
            const resumePreviewContainer = document.getElementById('resume-preview-container');
            const resumeContent = document.getElementById('resume-content');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const backToChatBtn = document.getElementById('back-to-chat-btn');

            // --- Initialization ---
            (async () => {
                const cachedLang = localStorage.getItem('currentLang') || 'en';
                currentLang = cachedLang;
                await loadTranslations(currentLang);
                if (SpeechRecognition) {
                    setupSpeechRecognition(); 
                }
                
                // Check for existing resume data
                const savedResumeData = localStorage.getItem('localResumeData');
                if (savedResumeData) {
                    resumeData = JSON.parse(savedResumeData);
                    // If we have complete data, enable preview option
                    if (resumeData.profession) {
                        const previewBtn = document.createElement('button');
                        previewBtn.className = 'option-btn done-btn';
                        previewBtn.textContent = 'Preview & Download Resume';
                        previewBtn.style.backgroundColor = 'var(--primary-dark)';
                        previewBtn.addEventListener('click', generateResumePreview);
                        
                        const optionsContainer = document.createElement('div');
                        optionsContainer.className = 'options-container';
                        optionsContainer.appendChild(previewBtn);
                        
                        chatDisplay.appendChild(optionsContainer);
                    }
                }

                // Show initial alert for offline mode
                const welcomeMsg = "Welcome to Professional Resume Builder. Create a professional, ATS-friendly resume in minutes.";
                showCustomAlert(welcomeMsg); 

            })();
            
            // --- Core TTS Functions ---
            function stopSpeech() {
                if (synth && synth.speaking) {
                    synth.cancel();
                }
                isSpeaking = false;
            }

            function speakText(text, langCode) {
                if (!synth) {
                    console.warn("Speech Synthesis not supported.");
                    return;
                }
                
                stopSpeech(); // Stop any previous speech
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langMap[langCode] || langCode;
                utterance.rate = 0.95;
                utterance.pitch = 1;
                
                lastSpokenText = text;
                isSpeaking = true;
                
                utterance.onend = () => { isSpeaking = false; };
                utterance.onerror = (event) => {
                    console.error("TTS Error:", event.error);
                    isSpeaking = false;
                };

                let voices = synth.getVoices().filter(voice => voice.lang === utterance.lang);

                if (voices.length > 0) {
                    utterance.voice = voices[0];
                    synth.speak(utterance);
                } else {
                    synth.speak(utterance);
                }
            }

            // --- Core Functions ---

            function applyTranslations() {
                if (!translations) {
                    console.error("No translations loaded.");
                    return;
                }
                
                document.querySelectorAll('[data-translation-key]').forEach(element => {
                    const key = element.dataset.translationKey;
                    let translation = translations[key];

                    if (key === 'subtitle_offline') {
                         translation = translations['subtitle_offline'] || "You are currently in **Offline Builder Mode**. Generate your professional resume locally with stored assets and core functionality.";
                    } else if (key === 'offline_tag') {
                         translation = translations['offline_tag'] || "Local Mode Active";
                    } else if (!translation) {
                        translation = translations[element.dataset.translationKey.replace('_offline', '')];
                    }

                    if (translation) {
                        const attr = element.dataset.translationAttr;
                        if (attr) {
                            element.setAttribute(attr, translation);
                        } else {
                            element.textContent = translation;
                        }
                    }
                });
                
                updatePlaceholder();
                
                if (createGoalBtn && createGoalBtn.disabled) {
                    createGoalBtn.disabled = false;
                    const btnText = document.getElementById('create-goal-btn-text');
                    if (btnText) {
                        btnText.textContent = 'Start Building Resume';
                    }
                }
                
                document.querySelectorAll('.option-btn').forEach(btn => {
                    let key = btn.dataset.key;
                    let text = "Error";
                    if (btn.classList.contains('profession-btn')) {
                        key = btn.dataset.key;
                        text = (translations.professions && translations.professions[key]) ? translations.professions[key] : key;
                    } else if (btn.classList.contains('done-btn')) {
                        text = translations['next'] || 'Done';
                    } else {
                        const qId = btn.dataset.questionId;
                        const index = btn.dataset.index;
                        if (qId && index !== undefined && translations.options && translations.options[qId] && translations.options[qId][index]) {
                            text = translations.options[qId][index];
                        } else {
                            text = key;
                        }
                    }
                    btn.textContent = text;
                    btn.dataset.text = text;
                });
                
                document.querySelectorAll('.chat-message .bot-message-text, .chat-message .user-message-text').forEach(element => {
                    const key = element.dataset.translationKey;
                    if (!key) return;
                    try {
                        if (key.startsWith('{')) {
                            const data = JSON.parse(key);
                            const newTexts = data.indices.map(index => {
                                const numIndex = parseInt(index, 10);
                                return translations.options[data.qId][numIndex] || `opt_${numIndex}`;
                            });
                            element.textContent = newTexts.join(', ');
                        } else if (key === 'none') {
                            element.textContent = translations['none'] || 'None';
                        } else if (key === 'profession_selected') {
                            const originalKey = resumeData.profession; 
                            const translatedProfession = translations.professions[originalKey] || element.dataset.professionText;
                            element.textContent = (translations['profession_selected'] || 'Great! {profession}.')
                                .replace('{profession}', translatedProfession);
                            element.dataset.professionText = translatedProfession; 
                        } else if (translations[key]) {
                            element.textContent = translations[key];
                        } else {
                            const parts = key.split('.');
                            if (parts.length === 2 && parts[0] === 'questions' && translations.questions && translations.questions[parts[1]]) {
                                element.textContent = translations.questions[parts[1]];
                            } else if (parts.length === 2 && parts[0] === 'professions' && translations.professions && translations.professions[parts[1]]) {
                                element.textContent = translations.professions[parts[1]];
                            } else if (parts.length === 3 && parts[0] === 'options' && translations.options && translations.options[parts[1]] && translations.options[parts[1]][parts[2]]) {
                                const numIndex = parseInt(parts[2], 10);
                                element.textContent = translations.options[parts[1]][numIndex];
                            }
                        }
                    } catch (e) {
                        console.error(`Error re-translating key: ${key}`, e);
                    }
                });
            }
            
            async function loadTranslations(langCode) {
                const cachedTranslations = localStorage.getItem('cached_translations');
                if (cachedTranslations) {
                    const parsedCache = JSON.parse(cachedTranslations);
                    if (parsedCache[langCode]) {
                         translations = parsedCache[langCode];
                         console.log(`Translations loaded from CACHE for: ${langCode}`);
                         applyTranslations();
                         return;
                    }
                }
                
                try {
                    const response = await fetch(`assets/translations/${langCode}.json`);
                    if (!response.ok) {
                        throw new Error(`Local file not found for ${langCode}.json`);
                    }
                    translations = await response.json();
                    console.log(`Translations loaded from LOCAL FILES for: ${langCode}`);

                    if (cachedTranslations) {
                        const parsedCache = JSON.parse(cachedTranslations);
                        parsedCache[langCode] = translations;
                        localStorage.setItem('cached_translations', JSON.stringify(parsedCache));
                    } else {
                        localStorage.setItem('cached_translations', JSON.stringify({ [langCode]: translations }));
                    }

                } catch (error) {
                    console.error(`Error loading translations for ${langCode}. Falling back to default 'en':`, error);
                    if (langCode !== 'en') {
                         await loadTranslations('en'); 
                         return;
                    } else {
                         translations = {
                             'welcome_title': 'Professional Resume Builder',
                             'subtitle_offline': 'Create a professional, ATS-friendly resume in minutes.',
                             'lets_make': 'Start Building Resume',
                             'type_answer': 'Type your answer...',
                             'select_profession': 'Select or Type...',
                             'next': 'OK',
                             'welcome_message': "Hello! I'm your resume assistant.",
                             'select_profession_prompt': "To start, please choose your profession from the list below.",
                             'alert_lang_change': 'Language set to',
                             'download_pdf': 'Download Resume as PDF', 
                             'resume_complete_offline': 'All questions answered! Your resume data is now ready and stored locally.',
                             'preview_and_download': 'Preview & Download Resume',
                         };
                    }
                }
                applyTranslations();
            }
            
            function updatePlaceholder() {
                if (!translations) return; 
                if (goalInput.disabled) {
                    goalInput.placeholder = translations['select_profession'] || 'Please select an option...';
                } else {
                    goalInput.placeholder = translations['type_answer'] || 'Type...';
                }
            }

            function addChatMessage(message, sender, options = {}) {
                if (!chatDisplay || message === undefined) {
                    console.error("Attempted to add undefined message or chatDisplay not found.");
                    return; 
                }; 
                const typingIndicator = chatDisplay.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message');
                let textSpan;
                if (sender === 'bot') {
                    messageElement.classList.add('bot-message');
                    messageElement.innerHTML = `
                        <div class="bot-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 4c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zM12 18c-3.314 0-6-2.686-6-6s2.686-6 6-6 6 2.686 6 6-2.686 6-6 6zM9 12c-0.552 0-1-0.448-1-1s0.448-1 1-1 1 0.448 1 1-0.448 1-1 1zM15 12c-0.552 0-1-0.448-1-1s0.448-1 1-1 1 0.448 1 1-0.448 1-1 1zM8 15h8v-1H8v1z"/></svg>
                        </div>
                        <span class="bot-message-text">${message}</span>
                    `;
                    textSpan = messageElement.querySelector('.bot-message-text');
                } else if (sender === 'typing') {
                    messageElement.classList.add('bot-message', 'typing-indicator');
                    messageElement.innerHTML = `
                        <div class="bot-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 4c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zM12 18c-3.314 0-6-2.686-6-6s2.686-6 6-6 6 2.686 6 6-2.686 6-6 6zM9 12c-0.552 0-1-0.448-1-1s0.448-1 1-1 1 0.448 1 1-0.448 1-1 1zM15 12c-0.552 0-1-0.448-1-1s0.448-1 1-1 1 0.448 1 1-0.448 1-1 1zM8 15h8v-1H8v1z"/></svg>
                        </div>
                        <span class="bot-message-text">
                            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                        </span>
                    `;
                } else {
                    messageElement.classList.add('user-message');
                    messageElement.innerHTML = `
                        <span class="user-message-text">${message}</span>
                        <div class="user-icon">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                    `;
                    textSpan = messageElement.querySelector('.user-message-text');
                }
                if (textSpan) {
                    if (options.translationKey) {
                        textSpan.dataset.translationKey = options.translationKey;
                    }
                    if (options.professionText) {
                        textSpan.dataset.professionText = options.professionText;
                    }
                }
                chatDisplay.appendChild(messageElement);
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            }
            
            function showTypingAndReply(callback) {
                addChatMessage(null, 'typing');
                setTimeout(() => {
                    callback();
                }, 1200);
            }

            function displayProfessionOptions() {
                removeOptions(); 
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                professions.forEach(prof => {
                    const button = document.createElement('button');
                    button.className = 'option-btn profession-btn'; 
                    const text = (translations.professions && translations.professions[prof.key])
                                            ? translations.professions[prof.key]
                                            : prof.key;
                    button.textContent = text;
                    button.dataset.key = prof.key; 
                    button.dataset.text = text;
                    button.addEventListener('click', handleProfessionClick);
                    optionsContainer.appendChild(button);
                });
                chatDisplay.appendChild(optionsContainer);
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            }

            async function handleProfessionClick(event) {
                stopSpeech();
                const professionKey = event.target.dataset.key; 
                const professionText = event.target.dataset.text; 
                addChatMessage(professionText, 'user', { translationKey: `professions.${professionKey}` });
                removeOptions();
                showTypingAndReply(async () => {
                    await handleProfessionInput(professionKey, professionText);
                });
            }

            function displayOptions(questionId, optionKeys, type) {
                removeOptions(); 
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                optionsContainer.dataset.questionId = questionId;
                optionKeys.forEach((key, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    const translatedText = (translations.options && translations.options[questionId] && translations.options[questionId][index])
                                                     ? translations.options[questionId][index]
                                                     : key; 
                    button.textContent = translatedText;
                    button.dataset.key = key; 
                    button.dataset.text = translatedText; 
                    button.dataset.type = type;
                    button.dataset.questionId = questionId;
                    button.dataset.index = index;
                    button.addEventListener('click', handleOptionClick);
                    optionsContainer.appendChild(button);
                });
                if (type === 'multi-select') {
                    const doneButton = document.createElement('button');
                    doneButton.className = 'option-btn done-btn';
                    doneButton.textContent = translations['next'] || 'Done';
                    doneButton.dataset.key = 'done';
                    doneButton.dataset.type = type;
                    doneButton.addEventListener('click', handleOptionClick);
                    optionsContainer.appendChild(doneButton);
                }
                chatDisplay.appendChild(optionsContainer);
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            }
            
            function handleOptionClick(event) {
                stopSpeech();
                const clickedBtn = event.target;
                const type = clickedBtn.dataset.type;
                const key = clickedBtn.dataset.key;
                const text = clickedBtn.dataset.text;
                const questionId = currentQuestionSet[currentQuestionIndex].id;
                const index = clickedBtn.dataset.index;

                if (type === 'mcq') {
                    resumeData[questionId] = key; 
                    addChatMessage(text, 'user', { translationKey: `options.${questionId}.${index}` }); 
                    removeOptions();
                    currentQuestionIndex++;
                    showTypingAndReply(askNextQuestion);
                } else if (type === 'multi-select') {
                    if (key === 'done') {
                        const selectedButtons = document.querySelectorAll('.option-btn.selected');
                        const selectedKeys = [];
                        const selectedTexts = [];
                        const selectedIndices = [];
                        selectedButtons.forEach(btn => {
                            selectedKeys.push(btn.dataset.key);
                            selectedTexts.push(btn.dataset.text);
                            selectedIndices.push(btn.dataset.index);
                        });
                        resumeData[questionId] = selectedKeys;
                        let joinedText;
                        let translationKey;
                        if (selectedTexts.length > 0) {
                            joinedText = selectedTexts.join(', ');
                            translationKey = JSON.stringify({ qId: questionId, indices: selectedIndices });
                        } else {
                            joinedText = translations['none'] || "None";
                            translationKey = 'none';
                        }
                        addChatMessage(joinedText, 'user', { translationKey: translationKey });
                        removeOptions();
                        currentQuestionIndex++;
                        showTypingAndReply(askNextQuestion);
                    } else {
                        clickedBtn.classList.toggle('selected');
                    }
                }
            }
            
            function removeOptions() {
                const existingOptions = chatDisplay.querySelector('.options-container');
                if (existingOptions) {
                    existingOptions.remove();
                }
            }

            function handleUserInput() {
                stopSpeech();
                if (goalInput.disabled) return;
                const inputText = goalInput.value.trim();
                if (!inputText) {
                    showCustomAlert(translations['alert_required'] || "Please type a message.");
                    return;
                }
                addChatMessage(inputText, 'user');
                goalInput.value = '';
                showTypingAndReply(async () => {
                    if (chatState === 'asking_questions') {
                        const question = currentQuestionSet[currentQuestionIndex];
                        resumeData[question.id] = inputText;
                        currentQuestionIndex++;
                        askNextQuestion();
                    }
                });
            }

            async function handleProfessionInput(professionKey, professionText) {
                try {
                    const response = await fetch(`assets/questions/${professionKey}.json`);
                    if (!response.ok) {
                        throw new Error(`File not found for ${professionKey}, using general.`);
                    }
                    const data = await response.json();
                    currentQuestionSet = data.questions; 
                } catch (e) {
                    console.warn(e.message);
                    const response = await fetch(`assets/questions/general.json`);
                    const data = await response.json();
                    currentQuestionSet = data.questions;
                    professionKey = 'general'; 
                }
                chatState = 'asking_questions'; 
                currentQuestionIndex = 0;
                resumeData = { 'profession': professionKey }; 
                
                const ackMsg = (translations['profession_selected'] || 'Great! {profession}.')
                                           .replace('{profession}', professionText);
                addChatMessage(ackMsg, 'bot', { 
                    translationKey: 'profession_selected', 
                    professionText: professionKey
                });
                speakText(ackMsg, currentLang); 
                setTimeout(askNextQuestion, 800);
            }

            function askNextQuestion() {
                stopSpeech();
                removeOptions(); 

                if (currentQuestionIndex < currentQuestionSet.length) {
                    const question = currentQuestionSet[currentQuestionIndex];
                    const questionText = (translations.questions && translations.questions[question.id])
                                                     ? translations.questions[question.id]
                                                     : (question.question || `Missing question for ${question.id}`);
                    
                    addChatMessage(questionText, 'bot', { translationKey: `questions.${question.id}` });
                    
                    let textToSpeak = questionText;

                    if (question.type === 'text' || question.type === 'tel' || question.type === 'email') {
                        goalInput.disabled = false;
                        sendBtn.disabled = false;
                        micBtn.disabled = false;
                        ttsBtn.disabled = false;
                        goalInput.placeholder = translations['type_answer'] || 'Type your answer...';
                        goalInput.focus();
                    } else if (question.type === 'mcq' || question.type === 'multi-select') {
                        goalInput.disabled = true;
                        sendBtn.disabled = true;
                        micBtn.disabled = false;
                        ttsBtn.disabled = false;
                        goalInput.placeholder = translations['select_profession'] || 'Please select an option...';
                        
                        displayOptions(question.id, question.options, question.type); 

                        const optionsContainer = chatDisplay.querySelector('.options-container');
                        let optionsText = "";
                        if (optionsContainer) {
                            const optionButtons = optionsContainer.querySelectorAll('.option-btn:not(.done-btn)');
                            optionButtons.forEach((btn, index) => {
                                optionsText += `${index + 1}. ${btn.dataset.text}. `;
                            });
                        }
                        textToSpeak += " " + optionsText; 
                    }

                    speakText(textToSpeak, currentLang);

                } else {
                    chatState = 'completed'; 
                    processCompletedResumeData();
                }
            }
            
            /* --- ENHANCED: Professional Resume Generation Functions --- */
            
            // Auto-elaboration function for simple answers
            function elaborateSimpleAnswer(questionId, userAnswer, profession) {
                if (!userAnswer || userAnswer.length > 50) {
                    return userAnswer; // Return as-is if already detailed or empty
                }
                
                const elaborationTemplates = {
                    objective: {
                        default: `Seeking a ${profession} position where I can utilize my skills and experience to contribute to organizational success while developing professionally.`,
                        cook: `Seeking a Cook position to apply my culinary skills in preparing high-quality meals while maintaining kitchen efficiency and food safety standards.`,
                        driver: `Looking for a Driver position to utilize my safe driving skills and knowledge of local routes to provide reliable transportation services.`,
                        security: `Seeking a Security Guard position to employ my vigilance and observation skills in maintaining safe and secure environments.`,
                        electrical: `Seeking an Electrical position to apply my technical skills in installing, maintaining, and repairing electrical systems with precision and safety.`,
                        plumbing: `Looking for a Plumbing position to utilize my expertise in installing and repairing pipes, fixtures, and other plumbing equipment.`,
                        construction: `Seeking a Construction position to apply my physical skills and technical knowledge in building and renovation projects.`,
                        carpentry: `Seeking a Carpentry position to utilize my woodworking skills and craftsmanship in creating quality structures and furniture.`,
                        welding: `Looking for a Welding position to apply my metalworking expertise in fabrication, repair, and construction projects.`,
                        painting: `Seeking a Painting position to utilize my attention to detail and color expertise in residential and commercial projects.`,
                        mechanic: `Looking for an Automotive Mechanic position to apply my technical skills in vehicle maintenance, repair, and diagnostics.`,
                        factory: `Seeking a Factory Worker position to contribute to manufacturing processes with efficiency and attention to quality control.`,
                        farm: `Looking for a Farm Worker position to utilize my agricultural knowledge and physical stamina in farming operations.`,
                        cleaning: `Seeking a Cleaning Professional position to maintain high standards of cleanliness and hygiene in various environments.`,
                        tailor: `Looking for a Tailor position to apply my sewing skills and fashion sense in garment creation and alterations.`,
                        automotive: `Seeking an Automotive Technician position to utilize my mechanical expertise in vehicle maintenance and repair.`,
                        general: `Seeking a professional position where I can apply my diverse skills and experience to contribute to organizational growth.`
                    },
                    keyAchievement1: {
                        default: `Successfully managed daily operations and consistently met performance targets through efficient work practices.`,
                        cook: `Prepared and served over 100 meals daily while maintaining high standards of food quality and kitchen hygiene.`,
                        driver: `Maintained a perfect safety record over 5 years of driving experience with no accidents or traffic violations.`,
                        security: `Effectively monitored premises and prevented unauthorized access, ensuring complete security of the facility.`,
                        electrical: `Installed and maintained electrical systems for over 50 residential and commercial projects with zero safety incidents.`,
                        plumbing: `Completed plumbing installations for 30+ residential properties while maintaining 100% customer satisfaction.`,
                        construction: `Contributed to the completion of 15+ construction projects on schedule and within budget constraints.`,
                        carpentry: `Built and installed custom furniture and structures for 20+ clients with exceptional craftsmanship.`,
                        welding: `Performed precision welding on structural components for various industrial and construction projects.`,
                        painting: `Completed painting projects for 25+ residential and commercial properties with excellent finish quality.`,
                        mechanic: `Diagnosed and repaired complex automotive issues, reducing vehicle downtime by 40% for customers.`,
                        factory: `Increased production efficiency by 15% through optimized workflow and quality control measures.`,
                        farm: `Managed crop cultivation and harvesting operations, achieving 20% higher yield than previous seasons.`,
                        cleaning: `Maintained 5-star cleanliness ratings across multiple facilities through systematic cleaning protocols.`,
                        tailor: `Created custom garments and performed alterations for 100+ satisfied customers with precise measurements.`
                    },
                    keyAchievement2: {
                        default: `Improved work processes that resulted in increased productivity and reduced operational costs.`,
                        cook: `Reduced food waste by 15% through improved inventory management and portion control techniques.`,
                        driver: `Optimized delivery routes to reduce fuel consumption by 10% while maintaining timely arrivals.`,
                        security: `Responded promptly to security incidents and effectively coordinated with local authorities when needed.`,
                        electrical: `Troubleshot and resolved complex electrical issues, reducing system downtime by 25%.`,
                        plumbing: `Implemented preventive maintenance schedules that reduced emergency repair calls by 40%.`,
                        construction: `Improved worksite safety protocols resulting in a 30% reduction in workplace accidents.`,
                        carpentry: `Reduced material waste by 20% through precise measurements and efficient cutting techniques.`,
                        welding: `Developed welding techniques that improved joint strength by 15% while reducing material usage.`,
                        painting: `Reduced paint waste by 25% through proper surface preparation and efficient application methods.`,
                        mechanic: `Streamlined repair processes, reducing average service time by 30 minutes per vehicle.`,
                        factory: `Implemented quality control measures that reduced defect rates by 18% in production lines.`,
                        farm: `Introduced irrigation techniques that reduced water consumption by 25% while maintaining crop health.`,
                        cleaning: `Developed cleaning schedules that improved efficiency by 20% while maintaining quality standards.`,
                        tailor: `Reduced fabric waste by 15% through optimized pattern cutting and material utilization.`
                    },
                    keyAchievement3: {
                        default: `Received consistent positive feedback from supervisors and clients for quality work and professionalism.`,
                        cook: `Trained 3 junior kitchen staff members in food preparation techniques and safety standards.`,
                        driver: `Maintained 98% on-time delivery rate across 500+ assignments over the past year.`,
                        security: `Conducted regular security audits that identified and addressed potential vulnerabilities.`,
                        electrical: `Mentored 2 apprentice electricians in safe installation practices and code compliance.`,
                        plumbing: `Developed customer service protocols that increased client retention by 25%.`,
                        construction: `Led a team of 5 workers in completing complex construction projects ahead of schedule.`,
                        carpentry: `Designed and built custom cabinetry that received excellent customer reviews and referrals.`,
                        welding: `Certified in multiple welding techniques including MIG, TIG, and arc welding processes.`,
                        painting: `Specialized in decorative painting techniques that attracted premium residential clients.`,
                        mechanic: `Maintained 95% customer satisfaction rate through thorough diagnostics and quality repairs.`,
                        factory: `Operated and maintained specialized machinery with 99% uptime and zero safety incidents.`,
                        farm: `Implemented organic farming practices that increased product value and market appeal.`,
                        cleaning: `Managed inventory of cleaning supplies, reducing costs by 15% through bulk purchasing.`,
                        tailor: `Stayed current with fashion trends and techniques through continuous professional development.`
                    },
                    otherSkills: {
                        default: `Hard-working, punctual, team player with excellent communication skills and ability to learn quickly.`,
                        cook: `Expertise in food safety standards, inventory management, meal planning, kitchen equipment operation, and efficient kitchen operations.`,
                        driver: `Defensive driving techniques, route planning, vehicle maintenance knowledge, GPS navigation, and excellent customer service skills.`,
                        security: `Surveillance monitoring, incident reporting, emergency response, conflict resolution, and excellent observational skills.`,
                        electrical: `Electrical system installation, troubleshooting, safety compliance, blueprint reading, team coordination, and code standards.`,
                        plumbing: `Pipe installation, leak detection, fixture repair, water system maintenance, customer service, and plumbing codes.`,
                        construction: `Blueprint reading, material handling, tool operation, safety protocols, teamwork, and construction techniques.`,
                        carpentry: `Woodworking, measuring and cutting precision, furniture construction, installation techniques, and material knowledge.`,
                        welding: `Metal fabrication, welding techniques, safety procedures, blueprint interpretation, and quality control.`,
                        painting: `Surface preparation, color mixing, brush and spray techniques, safety measures, and finish quality assessment.`,
                        mechanic: `Automotive diagnostics, engine repair, electrical systems, computerized systems, and customer communication.`,
                        factory: `Assembly line operations, quality control, machinery operation, safety procedures, and production efficiency.`,
                        farm: `Crop management, equipment operation, animal care, harvesting techniques, and agricultural best practices.`,
                        cleaning: `Chemical safety, equipment operation, time management, attention to detail, and hygiene standards.`,
                        tailor: `Sewing techniques, pattern making, fabric knowledge, measurements, alterations, and fashion trends.`,
                        automotive: `Vehicle diagnostics, repair techniques, computer systems, customer service, and technical knowledge.`
                    }
                };
                
                const template = elaborationTemplates[questionId];
                if (template) {
                    return template[profession] || template['default'] || userAnswer;
                }
                
                return userAnswer;
            }

            // Generate professional job title based on profession and experience
            function generateJobTitle(profession, yearsOfExperience) {
                const titleMap = {
                    'cook': yearsOfExperience > 5 ? 'Head Cook' : (yearsOfExperience > 2 ? 'Experienced Cook' : 'Cook'),
                    'driver': yearsOfExperience > 5 ? 'Senior Driver' : (yearsOfExperience > 2 ? 'Commercial Driver' : 'Driver'),
                    'security': yearsOfExperience > 5 ? 'Security Supervisor' : (yearsOfExperience > 2 ? 'Security Officer' : 'Security Guard'),
                    'electrical': yearsOfExperience > 5 ? 'Senior Electrician' : (yearsOfExperience > 2 ? 'Electrician' : 'Electrical Apprentice'),
                    'plumbing': yearsOfExperience > 5 ? 'Master Plumber' : (yearsOfExperience > 2 ? 'Plumber' : 'Plumbing Assistant'),
                    'construction': yearsOfExperience > 5 ? 'Construction Foreman' : (yearsOfExperience > 2 ? 'Construction Worker' : 'Construction Laborer'),
                    'carpentry': yearsOfExperience > 5 ? 'Master Carpenter' : (yearsOfExperience > 2 ? 'Carpenter' : 'Carpenter Helper'),
                    'welding': yearsOfExperience > 5 ? 'Welding Supervisor' : (yearsOfExperience > 2 ? 'Welder' : 'Welding Trainee'),
                    'painting': yearsOfExperience > 5 ? 'Lead Painter' : (yearsOfExperience > 2 ? 'Painter' : 'Painting Assistant'),
                    'mechanic': yearsOfExperience > 5 ? 'Senior Mechanic' : (yearsOfExperience > 2 ? 'Automotive Mechanic' : 'Mechanic Apprentice'),
                    'factory': yearsOfExperience > 5 ? 'Production Lead' : (yearsOfExperience > 2 ? 'Factory Worker' : 'Production Assistant'),
                    'farm': yearsOfExperience > 5 ? 'Farm Supervisor' : (yearsOfExperience > 2 ? 'Farm Worker' : 'Farm Hand'),
                    'cleaning': yearsOfExperience > 5 ? 'Cleaning Supervisor' : (yearsOfExperience > 2 ? 'Cleaning Professional' : 'Cleaner'),
                    'tailor': yearsOfExperience > 5 ? 'Master Tailor' : (yearsOfExperience > 2 ? 'Tailor' : 'Tailoring Assistant'),
                    'automotive': yearsOfExperience > 5 ? 'Automotive Technician' : (yearsOfExperience > 2 ? 'Automotive Mechanic' : 'Auto Repair Trainee'),
                    'general': yearsOfExperience > 5 ? 'Skilled Professional' : (yearsOfExperience > 2 ? 'Experienced Worker' : 'Entry-Level Professional')
                };
                
                return titleMap[profession] || 'Professional Worker';
            }

            // Generate professional summary based on user data
            function generateProfessionalSummary(data, profession) {
                const years = data.yearsOfExperience || 'several';
                const skills = data.otherSkills || 'hard-working and dedicated';
                const location = data.currentCity || '';
                const locationText = location ? ` based in ${location}` : '';
                
                const summaryTemplates = {
                    default: `Dedicated ${profession} with ${years} years of experience${locationText}. Proven ability to deliver quality work, meet organizational objectives, and adapt to challenging environments. Strong commitment to safety protocols and continuous improvement.`,
                    cook: `Skilled Cook with ${years} years of experience in food preparation, kitchen management, and culinary operations${locationText}. Expertise in maintaining high standards of food quality, safety, and customer satisfaction. Proficient in various cooking techniques and inventory management.`,
                    driver: `Professional Driver with ${years} years of experience and excellent safety record${locationText}. Skilled in route optimization, vehicle maintenance, defensive driving, and providing exceptional customer service. Knowledgeable of local routes and transportation regulations.`,
                    security: `Vigilant Security Professional with ${years} years of experience in monitoring premises and ensuring safety${locationText}. Trained in emergency response, conflict resolution, and surveillance techniques. Committed to maintaining secure environments through proactive measures.`,
                    electrical: `Qualified Electrical Technician with ${years} years of experience in installation, maintenance, and troubleshooting of electrical systems${locationText}. Strong knowledge of electrical codes, safety protocols, and modern electrical equipment. Committed to quality workmanship and client satisfaction.`,
                    plumbing: `Experienced Plumbing Specialist with ${years} years in residential and commercial plumbing${locationText}. Skilled in installation, repair, and maintenance of plumbing systems. Knowledgeable about modern plumbing techniques, water conservation, and customer service excellence.`,
                    construction: `Hard-working Construction Professional with ${years} years of experience in various construction projects${locationText}. Knowledgeable in safety protocols, blueprint reading, and efficient work practices. Proven ability to work effectively in team environments and meet project deadlines.`,
                    carpentry: `Skilled Carpenter with ${years} years of experience in woodworking and construction${locationText}. Expertise in furniture making, structural work, and finishing techniques. Strong attention to detail and commitment to quality craftsmanship in all projects.`,
                    welding: `Certified Welder with ${years} years of experience in metal fabrication and joining${locationText}. Proficient in MIG, TIG, and arc welding techniques. Knowledgeable about metallurgy, safety standards, and quality control in welding operations.`,
                    painting: `Professional Painter with ${years} years of experience in residential and commercial projects${locationText}. Skilled in surface preparation, color application, and finishing techniques. Strong attention to detail and commitment to delivering high-quality results.`,
                    mechanic: `Automotive Mechanic with ${years} years of experience in vehicle maintenance and repair${locationText}. Proficient in diagnostics, engine repair, and electrical systems. Committed to providing reliable service and maintaining vehicle safety standards.`,
                    factory: `Factory Worker with ${years} years of experience in manufacturing and production${locationText}. Skilled in assembly line operations, quality control, and machinery maintenance. Strong work ethic and ability to adapt to fast-paced production environments.`,
                    farm: `Agricultural Worker with ${years} years of farming experience${locationText}. Knowledgeable in crop cultivation, livestock care, and farm equipment operation. Committed to sustainable farming practices and quality agricultural production.`,
                    cleaning: `Cleaning Professional with ${years} years of experience in maintaining cleanliness standards${locationText}. Skilled in using cleaning equipment, chemical safety, and efficient cleaning techniques. Strong attention to detail and commitment to hygiene standards.`,
                    tailor: `Experienced Tailor with ${years} years in garment creation and alterations${locationText}. Skilled in sewing techniques, pattern making, and fabric knowledge. Strong eye for detail and commitment to customer satisfaction in all tailoring work.`,
                    automotive: `Automotive Technician with ${years} years of experience in vehicle repair and maintenance${locationText}. Proficient in modern automotive systems, diagnostics, and repair techniques. Committed to quality service and keeping vehicles in optimal condition.`
                };
                
                return summaryTemplates[profession] || summaryTemplates['default'];
            }

            // Generate work experience section with detailed achievements
            function generateWorkExperience(data, profession) {
                const years = data.yearsOfExperience || 'Recent';
                const company = data.companyName || 'Previous Employer';
                const location = data.jobCity || 'Location';
                const jobTitle = data.jobTitle || generateJobTitle(profession, parseInt(years) || 1);
                
                // Auto-elaborate achievements
                const achievement1 = elaborateSimpleAnswer('keyAchievement1', data.keyAchievement1, profession);
                const achievement2 = elaborateSimpleAnswer('keyAchievement2', data.keyAchievement2, profession);
                const achievement3 = elaborateSimpleAnswer('keyAchievement3', data.keyAchievement3, profession);
                
                let achievementsHtml = `
                    <li>${achievement1}</li>
                    <li>${achievement2}</li>
                `;
                
                if (achievement3 && achievement3 !== data.keyAchievement3) {
                    achievementsHtml += `<li>${achievement3}</li>`;
                } else if (data.keyAchievement3) {
                    achievementsHtml += `<li>${data.keyAchievement3}</li>`;
                }
                
                return `
                    <div class="experience-item">
                        <div class="job-header">
                            <div class="job-title">${jobTitle}</div>
                            <div class="job-date">${years} ${years === '1' ? 'Year' : 'Years'}</div>
                        </div>
                        <div class="company-name">${company} | ${location}</div>
                        <div class="job-description">
                            <ul class="achievement-list">
                                ${achievementsHtml}
                            </ul>
                        </div>
                    </div>
                `;
            }

            // Generate skills section with categorized skills
            function generateSkillsSection(data, profession) {
                const languages = (data.languages && data.languages.length > 0) 
                    ? data.languages.map(k => translations.options && translations.options.languages 
                        ? (translations.options.languages[k] || k) : k).join(', ') 
                    : 'Not Specified';
                    
                const tools = (data.tools && data.tools.length > 0) 
                    ? data.tools.map(k => translations.options && translations.options.tools 
                        ? (translations.options.tools[k] || k) : k).join(', ') 
                    : 'Not Specified';
                
                const otherSkills = elaborateSimpleAnswer('otherSkills', data.otherSkills, profession);
                
                const skillCategories = [];
                
                if (languages !== 'Not Specified') {
                    skillCategories.push(`
                        <div class="skill-category">
                            <div class="skill-category-title">Languages</div>
                            <div class="skill-tag">${languages}</div>
                        </div>
                    `);
                }
                
                if (tools !== 'Not Specified') {
                    skillCategories.push(`
                        <div class="skill-category">
                            <div class="skill-category-title">Tools & Equipment</div>
                            <div class="skill-tag">${tools}</div>
                        </div>
                    `);
                }
                
                if (otherSkills && otherSkills !== 'Not Specified') {
                    skillCategories.push(`
                        <div class="skill-category">
                            <div class="skill-category-title">Professional Skills</div>
                            <div class="skill-tag">${otherSkills}</div>
                        </div>
                    `);
                }
                
                // Add profession-specific skills
                const professionSkills = {
                    cook: 'Food Preparation, Kitchen Safety, Inventory Management',
                    driver: 'Defensive Driving, Route Planning, Vehicle Maintenance',
                    security: 'Surveillance, Emergency Response, Conflict Resolution',
                    electrical: 'Electrical Systems, Troubleshooting, Safety Compliance',
                    plumbing: 'Pipe Installation, Leak Detection, System Maintenance',
                    construction: 'Blueprint Reading, Safety Protocols, Team Coordination',
                    carpentry: 'Woodworking, Measurements, Installation',
                    welding: 'Metal Fabrication, Welding Techniques, Quality Control',
                    painting: 'Surface Preparation, Color Application, Finishing',
                    mechanic: 'Automotive Diagnostics, Engine Repair, Electrical Systems',
                    factory: 'Assembly Operations, Quality Control, Machinery',
                    farm: 'Crop Management, Equipment Operation, Harvesting',
                    cleaning: 'Chemical Safety, Equipment Operation, Hygiene Standards',
                    tailor: 'Sewing Techniques, Pattern Making, Alterations',
                    automotive: 'Vehicle Diagnostics, Repair Techniques, Customer Service'
                };
                
                if (professionSkills[profession]) {
                    skillCategories.push(`
                        <div class="skill-category">
                            <div class="skill-category-title">Specialized Skills</div>
                            <div class="skill-tag">${professionSkills[profession]}</div>
                        </div>
                    `);
                }
                
                return skillCategories.join('');
            }

            function generateResumePreview() {
                // Save data to localStorage first
                localStorage.setItem('localResumeData', JSON.stringify(resumeData));
                
                // Hide chat and show resume preview
                chatDisplay.classList.remove('visible');
                headerContent.classList.add('hidden');
                resumePreviewContainer.classList.add('visible');
                
                const data = resumeData;
                const profession = data.profession || 'general';
                const professionName = translations.professions ? (translations.professions[profession] || profession) : profession;
                const jobTitle = generateJobTitle(profession, parseInt(data.yearsOfExperience) || 1);
                const professionalSummary = generateProfessionalSummary(data, professionName);
                
                // Auto-elaborate simple answers
                const elaboratedObjective = elaborateSimpleAnswer('objective', data.objective, profession);
                
                // Build contact information
                let contactInfo = [];
                if (data.mobileNumber) contactInfo.push(`<span>${data.mobileNumber}</span>`);
                if (data.emailAddress) contactInfo.push(`<span>${data.emailAddress}</span>`);
                if (data.currentCity) contactInfo.push(`<span>${data.currentCity}</span>`);
                if (data.linkedinProfile) contactInfo.push(`<span>${data.linkedinProfile}</span>`);
                
                const resumeHtml = `
                    <div class="resume-header">
                        <div class="resume-name">${data.fullName || 'YOUR NAME'}</div>
                        <div class="resume-title">${jobTitle}</div>
                        <div class="resume-contact">
                            ${contactInfo.join('')}
                        </div>
                    </div>

                    <div class="resume-section">
                        <div class="section-title">Professional Summary</div>
                        <div class="summary-text">
                            ${professionalSummary}
                        </div>
                    </div>

                    <div class="resume-section">
                        <div class="section-title">Work Experience</div>
                        ${generateWorkExperience(data, profession)}
                    </div>
                    
                    <div class="resume-section">
                        <div class="section-title">Skills & Expertise</div>
                        <div class="skills-container">
                            ${generateSkillsSection(data, profession)}
                        </div>
                    </div>
                    
                    <div class="resume-section">
                        <div class="section-title">Education</div>
                        <div class="education-item">
                            <div class="education-degree">${data.qualification || 'High School Diploma or Equivalent'}</div>
                            <div class="education-school">${data.schoolCollege || 'School/College Name'}</div>
                            <div class="education-details">
                                ${data.passingYear ? `${data.passingYear} | ` : ''}
                                ${data.educationCity || 'City'}
                                ${data.percentageMarks ? ` | ${data.percentageMarks}%` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${data.certifications ? `
                    <div class="resume-section">
                        <div class="section-title">Certifications</div>
                        <div class="education-item">
                            <div class="education-details">${data.certifications}</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${elaboratedObjective && elaboratedObjective !== data.objective ? `
                    <div class="resume-section">
                        <div class="section-title">Career Objective</div>
                        <div class="summary-text">
                            ${elaboratedObjective}
                        </div>
                    </div>
                    ` : ''}
                `;
                
                resumeContent.innerHTML = resumeHtml;
            }

            function downloadResumePdf() {
                const element = document.getElementById('resume-content');
                const fullName = resumeData.fullName ? resumeData.fullName.replace(/\s+/g, '_') : 'Resume';
                const filename = `${fullName}_Professional_Resume.pdf`;
                
                // Use html2canvas and jsPDF for modern HTML rendering
                html2canvas(element, { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight + 10;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(filename);
                }).catch(error => {
                    console.error("PDF generation error:", error);
                    showCustomAlert("Failed to generate PDF. Please try again or use the print option.");
                });
            }

            // --- END: Resume Generation Functions ---
            
            async function processCompletedResumeData() {
                localStorage.setItem('localResumeData', JSON.stringify(resumeData));

                goalInput.disabled = true;
                sendBtn.disabled = true;
                micBtn.disabled = true;
                ttsBtn.disabled = true;
                goalInput.placeholder = translations['type_answer'] || 'Resume Ready!';
                
                const processingMsg = translations['resume_complete_offline'] || 'All questions answered! Your resume data is now ready and stored locally. You can preview and download your professional resume now.';
                addChatMessage(processingMsg, 'bot', { translationKey: 'resume_complete_offline' });
                speakText(processingMsg, currentLang);
                
                removeOptions();
                
                const finalOptionsContainer = document.createElement('div');
                finalOptionsContainer.className = 'options-container';

                const previewBtn = document.createElement('button');
                previewBtn.className = 'option-btn done-btn';
                previewBtn.textContent = translations['preview_and_download'] || 'Preview & Download Resume';
                previewBtn.style.backgroundColor = 'var(--primary-dark)';
                previewBtn.addEventListener('click', generateResumePreview); 

                finalOptionsContainer.appendChild(previewBtn);
                chatDisplay.appendChild(finalOptionsContainer);
                chatDisplay.scrollTop = chatDisplay.scrollHeight;

                console.log('--- FINAL RESUME DATA (OFFLINE) ---', resumeData);
            }
            
            function showCustomAlert(message) {
                if (alertMessage) alertMessage.textContent = message;
                if (alertOverlay) alertOverlay.style.display = 'flex';
                if (alertCloseBtn) alertCloseBtn.textContent = translations['next'] || 'OK';
            }
            
            if (alertCloseBtn) {
                alertCloseBtn.addEventListener('click', () => {
                    if (alertOverlay) alertOverlay.style.display = 'none';
                });
            }
            
            if (alertOverlay) {
                alertOverlay.addEventListener('click', (event) => {
                    if (event.target === alertOverlay) {
                        alertOverlay.style.display = 'none';
                    }
                });
            }

            function setupSpeechRecognition() {
                if (!SpeechRecognition) return; 
                
                recognition = new SpeechRecognition();
                recognition.lang = langMap[currentLang] || 'en-US';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isRecognizing = true;
                    micBtn.classList.add('listening');
                    ttsBtn.disabled = true;
                    const alertMsg = (chatState === 'awaiting_profession')
                        ? (translations['alert_voice_profession'] || "Please say the name of your profession...")
                        : (translations['alert_voice'] || "Listening... Please speak now.");
                    showCustomAlert(alertMsg);
                };

                recognition.onend = () => {
                    isRecognizing = false;
                    micBtn.classList.remove('listening');
                    ttsBtn.disabled = false;
                };

                recognition.onerror = (event) => {
                    console.error("Speech Recognition Error:", event.error);
                    let errorMsg = translations['alert_voice_error'] || "Voice error. Please try again.";
                    
                    if (event.error === 'no-speech') {
                        errorMsg = translations['alert_voice_no_speech'] || "No speech was detected. Please try again.";
                    } else if (event.error === 'not-allowed') {
                        errorMsg = translations['alert_voice_not_allowed'] || "Permission to use microphone was denied. Please allow it in your browser settings.";
                    } else if (event.error === 'network') {
                         errorMsg = translations['alert_voice_network_offline'] || "Voice input may be limited in Offline Mode. Try typing your answer.";
                    }
                    showCustomAlert(errorMsg);
                    ttsBtn.disabled = false;
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim(); 

                    if (chatState === 'awaiting_profession') {
                        const lowerTranscript = transcript.toLowerCase();
                        const professionButtons = document.querySelectorAll('.option-btn.profession-btn');
                        let matchFound = false;

                        for (const btn of professionButtons) {
                            const buttonText = btn.dataset.text.trim().toLowerCase(); 
                            
                            if (buttonText.includes(lowerTranscript) || lowerTranscript.includes(buttonText)) {
                                btn.click();
                                matchFound = true;
                                break; 
                            }
                        }

                        if (!matchFound) {
                            const errorMsgTemplate = translations['alert_voice_profession_nomatch'] || `Could not match "{transcript}". Please clearly say one of the profession names shown.`;
                            const errorMsg = errorMsgTemplate.replace('{transcript}', transcript); 
                            showCustomAlert(errorMsg);
                        }
                    } else if (chatState === 'asking_questions') {
                        const question = currentQuestionSet[currentQuestionIndex];
                        if (question.type === 'mcq' || question.type === 'multi-select') {
                            const lowerTranscript = transcript.toLowerCase();
                            const optionsContainer = chatDisplay.querySelector('.options-container');
                            let matchFound = false;

                            if (optionsContainer) {
                                const optionButtons = optionsContainer.querySelectorAll('.option-btn:not(.done-btn)');
                                optionButtons.forEach(btn => {
                                    const buttonText = btn.dataset.text.trim().toLowerCase();
                                    const index = parseInt(btn.dataset.index, 10) + 1;
                                    
                                    if (buttonText.includes(lowerTranscript) || lowerTranscript.includes(buttonText) || lowerTranscript.includes(String(index))) {
                                        btn.click();
                                        matchFound = true;
                                    }
                                });

                                if (question.type === 'multi-select' && (lowerTranscript.includes((translations['next'] || 'done').toLowerCase()))) {
                                    optionsContainer.querySelector('.done-btn').click();
                                    matchFound = true;
                                }
                            }

                            if (!matchFound) {
                                if (!goalInput.disabled) {
                                    goalInput.value = transcript;
                                    handleUserInput();
                                } else {
                                    showCustomAlert(translations['alert_voice_nomatch'] || `Could not match: "${transcript}". Please click a button.`);
                                }
                            }
                        } else if (!goalInput.disabled) {
                               goalInput.value = transcript;
                               handleUserInput(); 
                        }
                    }
                };
            }
            
            function toggleVoiceRecognition() {
                if (!recognition) {
                    setupSpeechRecognition(); 
                    if (!recognition) { 
                        showCustomAlert(translations['alert_voice_unsupported'] || "Speech recognition is not supported or failed to initialize.");
                        return;
                    }
                }

                if (isRecognizing) {
                    recognition.stop();
                } else {
                    stopSpeech();
                    const newLangCode = langMap[currentLang] || 'en-US';
                    if (recognition.lang !== newLangCode) {
                        recognition.lang = newLangCode;
                        console.log("Updated recognition language to:", newLangCode);
                    }
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting speech recognition:", e);
                        showCustomAlert(translations['alert_voice_start_error'] || "Could not start voice input. Please try again.");
                        isRecognizing = false; 
                        micBtn.classList.remove('listening');
                    }
                }
            }

            function switchToOnlineMode() {
                stopSpeech();
                showCustomAlert(translations['alert_switch_online'] || "Switching back to Online Builder. Resume data is stored locally. You may need to manually upload it there.");
                setTimeout(() => {
                    window.location.href = 'index.html'; 
                }, 1500);
            }

            function startChatSequence() {
                 if (headerContent) headerContent.classList.add('hidden');
                 if (resumePreviewContainer) resumePreviewContainer.classList.remove('visible');
                 if (chatDisplay) chatDisplay.classList.add('visible');
                 goalInput.disabled = true; 
                 sendBtn.disabled = true;
                 micBtn.disabled = false;
                 ttsBtn.disabled = false;
                 updatePlaceholder();

                 const welcomeMsg = translations['welcome_message'] || "Hello! I'm your AI resume assistant. I'll help you create a professional resume step by step.";
                 addChatMessage(welcomeMsg, 'bot', { translationKey: 'welcome_message' });
                 speakText(welcomeMsg, currentLang);

                 setTimeout(() => {
                    const askProfMsg = translations['select_profession_prompt'] || "To start, please choose your profession from the list below.";
                    addChatMessage(askProfMsg, 'bot', { translationKey: 'select_profession_prompt' });
                    
                    applyTranslations(); 
                    
                    displayProfessionOptions(); 

                    const optionsContainer = chatDisplay.querySelector('.options-container');
                    let optionsText = "";
                    if (optionsContainer) {
                        const optionButtons = optionsContainer.querySelectorAll('.option-btn');
                        optionButtons.forEach((btn, index) => {
                            optionsText += `${index + 1}. ${btn.dataset.text}. `;
                        });
                    }
                    speakText(askProfMsg + " " + optionsText, currentLang);
                 }, 1000);
            }

            // --- Event Listeners ---

            if (createGoalBtn) {
                createGoalBtn.addEventListener('click', startChatSequence);
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', handleUserInput);
            }
            
            if (goalInput) {
                goalInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        handleUserInput(); 
                    }
                });
            }
            
            if (micBtn && SpeechRecognition) {
                 micBtn.addEventListener('click', () => {
                     toggleVoiceRecognition();
                 });
            }
            
            if (ttsBtn) {
                ttsBtn.addEventListener('click', () => {
                    if (isSpeaking) {
                        stopSpeech();
                    } else if (lastSpokenText) {
                        speakText(lastSpokenText, currentLang); 
                    } else {
                        const alertMsg = translations['alert_no_text_spoken'] || "Nothing to read yet. The assistant will read questions as they appear.";
                        showCustomAlert(alertMsg);
                    }
                });
            }
            
            if (langButton && langDropdown) {
                langButton.addEventListener('click', (event) => {
                    event.stopPropagation(); 
                    langDropdown.classList.toggle('show');
                    langButton.setAttribute('aria-expanded', langDropdown.classList.contains('show'));
                });

                window.addEventListener('click', (event) => {
                    if (langDropdown.classList.contains('show') && !langButton.contains(event.target) && !langDropdown.contains(event.target)) {
                        langDropdown.classList.remove('show');
                        langButton.setAttribute('aria-expanded', 'false');
                    }
                });

                langOptions.forEach(option => {
                    option.addEventListener('click', async function(event) {
                        event.preventDefault(); 
                        
                        const selectedLanguageText = this.textContent;
                        const buttonText = selectedLanguageText.split(' ')[0];
                        const newLangCode = this.dataset.lang;
                        
                        if (langButtonText) langButtonText.textContent = buttonText;

                        langOptions.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        langDropdown.classList.remove('show');
                        langButton.setAttribute('aria-expanded', 'false');

                        if (newLangCode !== currentLang) {
                            currentLang = newLangCode;
                            stopSpeech();
                            await loadTranslations(currentLang); 
                            
                            if (recognition) {
                                const wasRecognizing = isRecognizing;
                                if (wasRecognizing) recognition.stop(); 
                                recognition.lang = langMap[newLangCode] || newLangCode;
                            }
                            
                            showCustomAlert(`${translations['alert_lang_change'] || 'Language set to'} ${selectedLanguageText}`);
                        }
                    });
                });
            }
            
            if (onlineModeBtn) {
                onlineModeBtn.addEventListener('click', switchToOnlineMode);
            }
            
            // PDF Download Listener
            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', downloadResumePdf);
            }
            
            // Back to Chat Listener
            if (backToChatBtn) {
                backToChatBtn.addEventListener('click', () => {
                    resumePreviewContainer.classList.remove('visible');
                    chatDisplay.classList.add('visible');
                });
            }
        });
    </script>
</body>
</html>